{% extends "base.html" %}

{% block title %}Mappa di Densità delle Strutture Sanitarie{% endblock %}

{% block additional_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>

<!-- Aggiungiamo custom CSS per la pagina della mappa -->
<style>
    #map-container {
        height: 600px;
        width: 100%;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
    }
    .map-controls {
        background: rgba(33, 37, 41, 0.85);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        max-width: 300px;
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 1000;
    }
    .map-legend {
        background: rgba(33, 37, 41, 0.85);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        position: absolute;
        bottom: 30px;
        right: 10px;
        z-index: 1000;
        min-width: 200px;
    }
    .gradient {
        height: 20px;
        background: linear-gradient(to right, rgba(0, 0, 255, 0.5), rgba(0, 255, 0, 0.5), rgba(255, 255, 0, 0.5), rgba(255, 0, 0, 0.8));
        margin: 5px 0;
        border-radius: 4px;
    }
    .gradient-labels {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #fff;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
        color: white;
        font-size: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Mappa di Densità delle Strutture Sanitarie in Italia</h1>
    
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card bg-dark">
                <div class="card-body">
                    <p class="card-text">
                        Questa mappa di calore mostra la distribuzione geografica delle strutture sanitarie in Italia. 
                        Le aree con una maggiore concentrazione di strutture sono evidenziate in rosso, mentre le aree 
                        con meno strutture sono in blu. Usa i filtri per visualizzare strutture specifiche o specialità.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div id="map-container" class="mb-4">
                <div id="map"></div>
                
                <!-- Controlli della mappa -->
                <div class="map-controls">
                    <h5 class="text-light mb-3">Filtri</h5>
                    
                    <div class="mb-3">
                        <label for="region-filter" class="form-label text-light">Regione</label>
                        <select class="form-select form-select-sm" id="region-filter">
                            <option value="">Tutte le regioni</option>
                            {% for region in regions %}
                            <option value="{{ region.name }}">{{ region.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="specialty-filter" class="form-label text-light">Specialità</label>
                        <select class="form-select form-select-sm" id="specialty-filter">
                            <option value="">Tutte le specialità</option>
                            {% for specialty in specialties %}
                            <option value="{{ specialty.name }}">{{ specialty.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="min-quality-filter" class="form-label text-light">Qualità minima</label>
                        <select class="form-select form-select-sm" id="min-quality-filter">
                            <option value="0">Qualsiasi</option>
                            <option value="1">⭐ e superiore</option>
                            <option value="2">⭐⭐ e superiore</option>
                            <option value="3">⭐⭐⭐ e superiore</option>
                            <option value="4">⭐⭐⭐⭐ e superiore</option>
                            <option value="4.5">⭐⭐⭐⭐½ e superiore</option>
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button id="apply-filters" class="btn btn-primary btn-sm">
                            <i class="fas fa-filter me-2"></i>Applica filtri
                        </button>
                        <button id="reset-filters" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                    </div>
                </div>
                
                <!-- Legenda della mappa -->
                <div class="map-legend">
                    <h6 class="text-light mb-2">Densità strutture</h6>
                    <div class="gradient"></div>
                    <div class="gradient-labels">
                        <span>Bassa</span>
                        <span>Alta</span>
                    </div>
                </div>
                
                <!-- Overlay di caricamento -->
                <div class="loading-overlay" id="loading-overlay">
                    <div class="text-center">
                        <div class="spinner-border text-light mb-2" role="status">
                            <span class="visually-hidden">Caricamento...</span>
                        </div>
                        <div>Caricamento dati...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card bg-dark mb-4">
                <div class="card-body">
                    <h5 class="card-title">Informazioni sulla mappa</h5>
                    <p class="card-text">
                        Questa visualizzazione utilizza i dati di {{ stats.total_facilities }} strutture sanitarie presenti nel nostro database,
                        di cui {{ stats.geocoded_facilities }} ({{ stats.geocoded_percentage }}%) hanno coordinate geografiche precise.
                    </p>
                    <p class="card-text">
                        La mappa mostra le concentrazioni di strutture sanitarie nelle diverse aree dell'Italia,
                        permettendo di identificare rapidamente le zone con maggiore o minore presenza di servizi sanitari.
                    </p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> 
                        Cliccando su un punto della mappa verranno mostrate le strutture sanitarie presenti in quell'area.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<!-- Leaflet Heatmap Plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

<!-- Mappa di densità JS -->
<script src="{{ url_for('static', filename='js/heatmap.js') }}"></script>
{% endblock %}