{% extends "base.html" %}

{% block title %}Risultati della Ricerca{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Risultati della Ricerca</li>
            </ol>
        </nav>
        
        <!-- Database initialization alerts removed -->
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">Strutture Sanitarie</h1>
            <a href="/" class="btn btn-outline-primary">
                <i class="fas fa-search me-2"></i> Nuova Ricerca
            </a>
        </div>
        
        <!-- Rating methodology information card (permanent) -->
        <div class="card border-info bg-dark shadow-sm mb-4">
            <div class="card-body">
                <div class="d-flex">
                    <div class="flex-shrink-0 me-3">
                        <div class="rounded-circle bg-info bg-opacity-10 p-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                            <i class="fas fa-info-circle text-info fa-2x"></i>
                        </div>
                    </div>
                    <div>
                        <h5 class="card-title text-info">Il nostro sistema di valutazione delle specialità</h5>
                        <p class="card-text mb-0">Ogni struttura è valutata da 1 a 5 in 8 specialità chiave (Cardiologia, Ortopedia, Oncologia, Neurologia, Urologia, Chirurgia, Pediatria, Ginecologia) basandosi sui dati ufficiali del Programma Nazionale Esiti (PNE), rapporti AGENAS, e altre fonti verificate come Micuro e QSalute.</p>
                        <button type="button" class="btn btn-sm btn-info mt-2" data-bs-toggle="modal" data-bs-target="#ratingMethodologyModal">
                            <i class="fas fa-search-plus me-1"></i> Scopri di più sulla nostra metodologia
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filter Summary -->
        <div class="card bg-dark border-0 shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">Filtri Applicati</h5>
                <div class="row">
                    {% if search_params.query_text %}
                    <div class="col-md-12 mb-2">
                        <p class="mb-1"><strong>Ricerca Testuale:</strong></p>
                        <p>"{{ search_params.original_query if search_params.original_query else search_params.query_text }}"</p>
                        
                        {% if search_params.detected_location %}
                        <p class="mb-1 mt-2"><strong>Abbiamo rilevato la località:</strong></p>
                        <span class="badge bg-success">{{ search_params.detected_location }}</span>
                        <small class="text-muted mt-1 d-block">Stiamo mostrando le strutture nella regione {{ search_params.detected_location }}</small>
                        {% endif %}
                        
                        {% if search_params.mapped_specialties %}
                        <p class="mb-1 mt-2"><strong>Specialità associate alla ricerca:</strong></p>
                        <div class="d-flex flex-wrap gap-1 mt-1">
                            {% for specialty in search_params.mapped_specialties %}
                            <span class="badge bg-info">{{ specialty }}</span>
                            {% endfor %}
                        </div>
                        <small class="text-muted mt-1 d-block">La tua ricerca è stata associata a queste specialità mediche</small>
                        {% endif %}
                    </div>
                    {% endif %}
                    <div class="col-md-3">
                        <p class="mb-1"><strong>Specialità:</strong></p>
                        <p>{{ search_params.specialty if search_params.specialty else 'Tutte' }}</p>
                    </div>
                    <div class="col-md-3">
                        <p class="mb-1"><strong>Regione:</strong></p>
                        <p>{{ search_params.region if search_params.region else 'Tutte' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Qualità Minima:</strong></p>
                        <p>{{ search_params.min_quality if search_params.min_quality > 0 else 'Qualsiasi' }}
                        {% if search_params.min_quality > 0 %}/5{% endif %}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Count (in permanent card) -->
        <div class="card border-{% if facilities|length > 0 %}info{% else %}warning{% endif %} bg-dark shadow-sm mb-4">
            <div class="card-body">
                {% if facilities|length > 0 %}
                    <h5 class="card-title text-info">
                        <i class="fas fa-info-circle me-2"></i>Risultati della Ricerca
                    </h5>
                    <p class="card-text">Trovate {{ facilities|length }} strutture sanitarie che corrispondono ai criteri di ricerca.</p>
                    <p class="card-text text-muted mb-0">
                        <i class="fas fa-lightbulb me-1"></i> Nota: Per garantire le migliori prestazioni dell'applicazione, abbiamo limitato i dati a 5 strutture per ciascuna delle 20 regioni italiane, recuperati da fonti dati pubbliche.
                    </p>
                {% else %}
                    <h5 class="card-title text-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Nessun Risultato
                    </h5>
                    <p class="card-text mb-0">Nessuna struttura sanitaria trovata con i criteri selezionati. Prova a modificare i filtri di ricerca.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Sort Controls -->
        {% if facilities|length > 0 %}
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <form id="sortForm" action="/search" method="get" class="d-inline">
                        <!-- Hidden fields to preserve current search parameters -->
                        <input type="hidden" name="specialty" value="{{ search_params.specialty }}">
                        <input type="hidden" name="region" value="{{ search_params.region }}">
                        <input type="hidden" name="min_quality" value="{{ search_params.min_quality }}">
                        <input type="hidden" name="query_text" value="{{ search_params.query_text }}">
                        
                        <label for="sort_by" class="form-label me-2">Ordina per:</label>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="sort_by" name="sort_by" onchange="document.getElementById('sortForm').submit();">
                            <option value="quality_desc" {% if search_params.sort_by == 'quality_desc' %}selected{% endif %}>Qualità (Migliore prima)</option>
                            <option value="quality_asc" {% if search_params.sort_by == 'quality_asc' %}selected{% endif %}>Qualità (Peggiore prima)</option>
                            <option value="name_asc" {% if search_params.sort_by == 'name_asc' %}selected{% endif %}>Nome (A-Z)</option>
                            <option value="name_desc" {% if search_params.sort_by == 'name_desc' %}selected{% endif %}>Nome (Z-A)</option>
                            <option value="city_asc" {% if search_params.sort_by == 'city_asc' %}selected{% endif %}>Città (A-Z)</option>
                            <option value="city_desc" {% if search_params.sort_by == 'city_desc' %}selected{% endif %}>Città (Z-A)</option>
                        </select>
                    </form>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" id="viewGrid">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="viewList">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Results Grid -->
        {% if facilities|length > 0 %}
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5" id="facilitiesGrid">
            {% for facility in facilities %}
            <div class="col facility-card" 
                data-name="{{ facility.name }}" 
                data-quality="{{ facility.quality_score or 0 }}">
                <div class="card h-100 bg-dark border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">{{ facility.name }}</h5>
                            <span class="badge bg-info">{{ facility.facility_type }}</span>
                        </div>
                        
                        <p class="card-text text-muted mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            {{ facility.address }}, {{ facility.city }}
                            {% if facility.region %}
                            <br><i class="fas fa-map me-2"></i>{{ facility.region.name }}
                            {% endif %}
                        </p>
                        
                        <div class="mb-3">
                            <h6 class="mb-2">Specialità:</h6>
                            <div class="d-flex flex-wrap gap-1">
                                {% for specialty in facility.specialties_list %}
                                <span class="badge bg-primary">{{ specialty }}</span>
                                {% else %}
                                <span class="badge bg-secondary">Informazione non disponibile</span>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-12">
                                <h6 class="mb-1">Qualità Generale:</h6>
                                <div class="facility-rating">
                                    {% if facility.quality_score %}
                                        <div class="stars" style="--rating: {{ facility.quality_score }};">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <div class="overlay">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                            </div>
                                        </div>
                                        <span class="ms-2">{{ format_quality(facility.quality_score) }}</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Specialty Ratings - Modernized Design -->
                        {% if facility.cardiology_rating or facility.orthopedics_rating or facility.oncology_rating or facility.neurology_rating or facility.surgery_rating or facility.urology_rating or facility.pediatrics_rating or facility.gynecology_rating %}
                        <div class="mt-3 specialty-ratings">
                            <h6 class="mb-2">Valutazioni per Specialità:</h6>
                            
                            {% if facility.cardiology_rating %}
                            <div class="specialty-rating-item">
                                <div class="specialty-name">Cardiologia</div>
                                <div class="rating-bar">
                                    <div class="rating-fill" style="width: {{ facility.cardiology_rating*20 }}%;"></div>
                                </div>
                                <div class="rating-value">{{ format_quality(facility.cardiology_rating) }}</div>
                            </div>
                            {% endif %}
                            
                            {% if facility.orthopedics_rating %}
                            <div class="specialty-rating-item">
                                <div class="specialty-name">Ortopedia</div>
                                <div class="rating-bar">
                                    <div class="rating-fill" style="width: {{ facility.orthopedics_rating*20 }}%;"></div>
                                </div>
                                <div class="rating-value">{{ format_quality(facility.orthopedics_rating) }}</div>
                            </div>
                            {% endif %}
                            
                            {% if facility.oncology_rating %}
                            <div class="specialty-rating-item">
                                <div class="specialty-name">Oncologia</div>
                                <div class="rating-bar">
                                    <div class="rating-fill" style="width: {{ facility.oncology_rating*20 }}%;"></div>
                                </div>
                                <div class="rating-value">{{ format_quality(facility.oncology_rating) }}</div>
                            </div>
                            {% endif %}
                            
                            {% if facility.neurology_rating %}
                            <div class="specialty-rating-item">
                                <div class="specialty-name">Neurologia</div>
                                <div class="rating-bar">
                                    <div class="rating-fill" style="width: {{ facility.neurology_rating*20 }}%;"></div>
                                </div>
                                <div class="rating-value">{{ format_quality(facility.neurology_rating) }}</div>
                            </div>
                            {% endif %}
                            
                            {% if facility.surgery_rating %}
                            <div class="specialty-rating-item">
                                <div class="specialty-name">Chirurgia</div>
                                <div class="rating-bar">
                                    <div class="rating-fill" style="width: {{ facility.surgery_rating*20 }}%;"></div>
                                </div>
                                <div class="rating-value">{{ format_quality(facility.surgery_rating) }}</div>
                            </div>
                            {% endif %}
                            
                            {% if facility.urology_rating %}
                            <div class="specialty-rating-item">
                                <div class="specialty-name">Urologia</div>
                                <div class="rating-bar">
                                    <div class="rating-fill" style="width: {{ facility.urology_rating*20 }}%;"></div>
                                </div>
                                <div class="rating-value">{{ format_quality(facility.urology_rating) }}</div>
                            </div>
                            {% endif %}
                            
                            {% if facility.pediatrics_rating %}
                            <div class="specialty-rating-item">
                                <div class="specialty-name">Pediatria</div>
                                <div class="rating-bar">
                                    <div class="rating-fill" style="width: {{ facility.pediatrics_rating*20 }}%;"></div>
                                </div>
                                <div class="rating-value">{{ format_quality(facility.pediatrics_rating) }}</div>
                            </div>
                            {% endif %}
                            
                            {% if facility.gynecology_rating %}
                            <div class="specialty-rating-item">
                                <div class="specialty-name">Ginecologia</div>
                                <div class="rating-bar">
                                    <div class="rating-fill" style="width: {{ facility.gynecology_rating*20 }}%;"></div>
                                </div>
                                <div class="rating-value">{{ format_quality(facility.gynecology_rating) }}</div>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if facility.strengths_summary %}
                        <div class="mt-2">
                            <p class="mb-0 text-info"><i class="fas fa-certificate me-1"></i> {{ facility.strengths_summary }}</p>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        {% if facility.telephone %}
                        <div class="contact-info mt-3 pt-3 border-top">
                            <p class="mb-1">
                                <i class="fas fa-phone me-2"></i>
                                <a href="tel:{{ facility.telephone }}">{{ facility.telephone }}</a>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-dark border-top-0">
                        <small class="text-muted">Fonte: {{ facility.data_source }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Results List (hidden by default) -->
        <div class="mb-5 d-none" id="facilitiesList">
            <div class="list-group">
                {% for facility in facilities %}
                <div class="list-group-item bg-dark border-light facility-item"
                    data-name="{{ facility.name }}" 
                    data-quality="{{ facility.quality_score or 0 }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">{{ facility.name }}</h5>
                                <span class="badge bg-info">{{ facility.facility_type }}</span>
                            </div>
                            <p class="mb-1 text-muted">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ facility.address }}, {{ facility.city }}
                                {% if facility.region %}
                                - {{ facility.region.name }}
                                {% endif %}
                            </p>
                            <div class="mb-2">
                                {% for specialty in facility.specialties_list %}
                                <span class="badge bg-primary me-1">{{ specialty }}</span>
                                {% else %}
                                <span class="badge bg-secondary">Informazione non disponibile</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mt-2 mt-md-0">
                                <h6 class="mb-1">Qualità Generale:</h6>
                                <div class="facility-rating">
                                    {% if facility.quality_score %}
                                        <div class="stars" style="--rating: {{ facility.quality_score }};">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <div class="overlay">
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                                <i class="fas fa-star"></i>
                                            </div>
                                        </div>
                                        <span class="ms-2">{{ format_quality(facility.quality_score) }}</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                            

                            
                            {% if facility.telephone %}
                            <p class="mb-0 mt-2">
                                <i class="fas fa-phone me-1"></i>
                                <a href="tel:{{ facility.telephone }}">{{ facility.telephone }}</a>
                            </p>
                            {% endif %}
                        </div>
                        
                        <!-- Specialty Ratings in List View - Modernized Design -->
                        <div class="col-md-3">
                            {% if facility.cardiology_rating or facility.orthopedics_rating or facility.oncology_rating or facility.neurology_rating or facility.surgery_rating or facility.urology_rating or facility.pediatrics_rating or facility.gynecology_rating %}
                            <div class="mt-2 mt-md-0 specialty-ratings">
                                <h6 class="mb-1">Valutazioni per Specialità:</h6>
                                
                                {% if facility.cardiology_rating %}
                                <div class="specialty-rating-item">
                                    <div class="specialty-name">Cardiologia</div>
                                    <div class="rating-bar">
                                        <div class="rating-fill" style="width: {{ facility.cardiology_rating*20 }}%;"></div>
                                    </div>
                                    <div class="rating-value">{{ format_quality(facility.cardiology_rating) }}</div>
                                </div>
                                {% endif %}
                                
                                {% if facility.oncology_rating %}
                                <div class="specialty-rating-item">
                                    <div class="specialty-name">Oncologia</div>
                                    <div class="rating-bar">
                                        <div class="rating-fill" style="width: {{ facility.oncology_rating*20 }}%;"></div>
                                    </div>
                                    <div class="rating-value">{{ format_quality(facility.oncology_rating) }}</div>
                                </div>
                                {% endif %}
                                
                                {% if facility.neurology_rating %}
                                <div class="specialty-rating-item">
                                    <div class="specialty-name">Neurologia</div>
                                    <div class="rating-bar">
                                        <div class="rating-fill" style="width: {{ facility.neurology_rating*20 }}%;"></div>
                                    </div>
                                    <div class="rating-value">{{ format_quality(facility.neurology_rating) }}</div>
                                </div>
                                {% endif %}
                                
                                {% if facility.strengths_summary %}
                                <div class="mt-2">
                                    <small class="text-info"><i class="fas fa-certificate me-1"></i> {{ facility.strengths_summary }}</small>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

<!-- Rating Methodology Modal -->
<div class="modal fade" id="ratingMethodologyModal" tabindex="-1" aria-labelledby="ratingMethodologyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="ratingMethodologyModalLabel">Metodologia di Valutazione delle Specialità</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6 class="text-info"><i class="fas fa-chart-line me-2"></i>Analisi dei Dati e Sistema di Classificazione</h6>
                    <p>Abbiamo sviluppato un sistema di classificazione completo e strutturato per le strutture mediche in tutta Italia analizzando un ampio dataset di ospedali e cliniche. Il nostro obiettivo è stato identificare i punti di forza di ciascuna struttura tra le specialità mediche chiave — cardiologia, ortopedia, oncologia, neurologia, urologia, chirurgia generale, pediatria e ginecologia — e assegnare a ciascuna un rating di prestazione da 1 a 5 per specialità.</p>
                </div>
                
                <div class="mb-4">
                    <h6 class="text-info"><i class="fas fa-database me-2"></i>Fonti di Dati</h6>
                    <p>Questa valutazione si basa principalmente su dati pubblici ufficiali, come rapporti nazionali di outcome del Programma Nazionale Esiti (PNE) di AGENAS, ed è stata arricchita con fonti esterne affidabili tra cui Micuro, QSalute e rapporti istituzionali dove disponibili. Dove i dati pubblici erano carenti, abbiamo integrato utilizzando la reputazione istituzionale, le classifiche regionali e il feedback verificato degli utenti.</p>
                </div>
                
                <div class="mb-4">
                    <h6 class="text-info"><i class="fas fa-star-half-alt me-2"></i>Scala di Valutazione</h6>
                    <p>Ogni struttura è valutata su una scala da 1 a 5:</p>
                    <ul>
                        <li><strong>5 stelle:</strong> Eccezionale - Centro di eccellenza riconosciuto a livello nazionale</li>
                        <li><strong>4 stelle:</strong> Ottimo - Prestazioni superiori alla media in questa specialità</li>
                        <li><strong>3 stelle:</strong> Buono - Prestazioni nella media con punti di forza in questa specialità</li>
                        <li><strong>2 stelle:</strong> Adeguato - Struttura con servizi di base in questa specialità</li>
                        <li><strong>1 stella:</strong> Limitato - Presenza minima o periferica della specialità</li>
                    </ul>
                    <p>Le specialità di ogni struttura sono state identificate e una scala di valutazione è stata applicata per riflettere le sue prestazioni o il riconoscimento in quelle aree.</p>
                </div>
                
                <div>
                    <h6 class="text-info"><i class="fas fa-search me-2"></i>Risultato della Nostra Analisi</h6>
                    <p>Il risultato è un dataset comparativo e consultabile che aiuta pazienti, professionisti o amministratori sanitari a identificare rapidamente la struttura migliore per qualsiasi specialità o esigenza di trattamento — con sicurezza basata sui dati e copertura nazionale.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View switching
    const viewGrid = document.getElementById('viewGrid');
    const viewList = document.getElementById('viewList');
    const facilitiesGrid = document.getElementById('facilitiesGrid');
    const facilitiesList = document.getElementById('facilitiesList');
    
    if (viewGrid && viewList) {
        viewGrid.addEventListener('click', function() {
            facilitiesGrid.classList.remove('d-none');
            facilitiesList.classList.add('d-none');
            viewGrid.classList.add('btn-outline-primary');
            viewGrid.classList.remove('btn-outline-secondary');
            viewList.classList.add('btn-outline-secondary');
            viewList.classList.remove('btn-outline-primary');
        });
        
        viewList.addEventListener('click', function() {
            facilitiesGrid.classList.add('d-none');
            facilitiesList.classList.remove('d-none');
            viewList.classList.add('btn-outline-primary');
            viewList.classList.remove('btn-outline-secondary');
            viewGrid.classList.add('btn-outline-secondary');
            viewGrid.classList.remove('btn-outline-primary');
        });
    }
    
    // Note: We've removed client-side sorting since we're now using server-side sorting
    // The sorting is handled by the backend via the sort_by parameter
});
</script>
{% endblock %}
